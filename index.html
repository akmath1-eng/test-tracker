<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Test Performance Analysis</title>
    <link rel="apple-touch-icon" href="https://icons.iconarchive.com/icons/custom-icon-design/flatastic-4/512/Chart-icon.png">
    <link rel="icon" type="image/png" href="https://icons.iconarchive.com/icons/custom-icon-design/flatastic-4/512/Chart-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Test Tracker">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f3f4f6;
            --surface: #ffffff;
            --border: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --primary: #2563eb; /* Slightly deeper blue for pro look */
            --accent-phy: #ef4444;
            --accent-chem: #10b981;
            --accent-math: #f59e0b;
            --accent-silly: #f43f5e;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --primary: #60a5fa;
            --accent-phy: #f87171;
            --accent-chem: #34d399;
            --accent-math: #fbbf24;
            --accent-silly: #fb7185;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; transition: background-color 0.3s, border-color 0.3s; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--bg); color: var(--text-primary); margin: 0; padding: 20px; font-size: 15px; line-height: 1.5; }

        /* --- Header --- */
        header { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto 24px auto; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        h1 { margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
        
        .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .btn-icon { background: var(--surface); border: 1px solid var(--border); color: var(--text-primary); padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 6px; box-shadow: var(--shadow); }
        .btn-icon:active { transform: translateY(1px); }
        
        .tab-container { background: var(--surface); padding: 4px; border-radius: 8px; display: flex; border: 1px solid var(--border); box-shadow: var(--shadow); }
        .tab { padding: 8px 20px; cursor: pointer; border-radius: 6px; font-weight: 500; color: var(--text-secondary); user-select: none; font-size: 0.9rem; }
        .tab.active { background-color: var(--bg); color: var(--text-primary); font-weight: 600; box-shadow: var(--shadow); }

        /* --- Layout --- */
        .main-grid { display: grid; grid-template-columns: 350px 1fr; gap: 30px; max-width: 1200px; margin: 0 auto; }
        .panel { background: var(--surface); padding: 24px; border-radius: 16px; border: 1px solid var(--border); height: fit-content; margin-bottom: 24px; box-shadow: var(--shadow); }
        
        /* --- Form --- */
        .section-title { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.9rem; }
        
        /* Larger touch targets for iPad */
        input { width: 100%; padding: 12px 14px; background: var(--bg); border: 1px solid var(--border); color: var(--text-primary); border-radius: 8px; outline: none; font-size: 1rem; -webkit-appearance: none; }
        input:focus { border-color: var(--primary); ring: 2px solid var(--primary); }
        
        .row-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .mini-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 8px; }
        .mini-inputs input { padding: 10px; font-size: 0.85rem; background: rgba(0,0,0,0.02); border-color: transparent; text-align: center; }
        .mini-inputs input:focus { background: var(--bg); border-color: var(--primary); }
        
        .btn-primary { width: 100%; padding: 14px; background-color: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 10px; font-size: 1rem; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); }
        .btn-primary:active { transform: translateY(1px); }

        .goal-wrapper { display: flex; align-items: center; gap: 12px; margin-bottom: 0; background: var(--bg); padding: 12px; border-radius: 10px; }
        .goal-wrapper input { width: 100px; text-align: center; font-weight: bold; color: var(--primary); border: 1px solid var(--border); background: var(--surface); }

        /* --- Stats --- */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--surface); padding: 20px; border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow); }
        .stat-val { font-size: 1.8rem; font-weight: 700; color: var(--text-primary); line-height: 1.2; }
        .stat-label { color: var(--text-secondary); font-size: 0.85rem; font-weight: 500; margin-top: 4px; }

        /* --- Charts --- */
        .section-header { font-size: 1.2rem; font-weight: 600; margin: 40px 0 20px 0; color: var(--text-primary); border-left: 5px solid var(--primary); padding-left: 15px; }
        .charts-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 24px; }
        .chart-card { background: var(--surface); padding: 24px; border-radius: 16px; border: 1px solid var(--border); height: 360px; position: relative; box-shadow: var(--shadow); }
        .full-width { grid-column: span 2; }

        /* --- Table --- */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; font-size: 0.95rem; }
        th { text-align: left; padding: 16px; color: var(--text-secondary); font-weight: 500; border-bottom: 1px solid var(--border); background: var(--surface); position: sticky; top: 0; }
        td { padding: 16px; border-bottom: 1px solid var(--border); color: var(--text-primary); vertical-align: middle; }
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; display: inline-block; margin-right: 8px; }
        .badge-main { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
        .badge-adv { background: rgba(245, 158, 11, 0.1); color: var(--accent-math); }
        .delete-btn { cursor:pointer; color:var(--text-secondary); font-weight:bold; font-size: 1.2rem; line-height: 0; }
        .delete-btn:hover { color: var(--accent-phy); }

        #fileInput { display: none; }

        /* --- iPad / Tablet Responsive Breakpoints --- */
        @media (max-width: 1024px) {
            .main-grid { grid-template-columns: 1fr; } /* Stack sidebar on top for portrait tablets */
            .sidebar { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; } /* Split sidebar content */
            .charts-container { grid-template-columns: 1fr; } /* Single col charts on narrow tablets */
            .full-width { grid-column: span 1; }
            .stats-row { grid-template-columns: 1fr 1fr; } /* 2x2 stats */
        }

        @media (max-width: 700px) {
            .sidebar { grid-template-columns: 1fr; } /* Stack everything on mobile */
            header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .controls { width: 100%; justify-content: space-between; }
        }
    </style>
</head>
<body>

<header>
    <h1>Test Performance Analysis</h1>
    <div class="controls">
        <button class="btn-icon" onclick="exportData()">Export</button>
        <button class="btn-icon" onclick="document.getElementById('fileInput').click()">Import</button>
        <input type="file" id="fileInput" accept=".json" onchange="importData(this)">
        <div class="tab-container">
            <div class="tab active" onclick="setMode('Main')" id="tabMain">Main</div>
            <div class="tab" onclick="setMode('Adv')" id="tabAdv">Advanced</div>
        </div>
        <button class="btn-icon" onclick="toggleTheme()" id="themeIcon">Dark Mode</button>
    </div>
</header>

<div class="main-grid">
    <div class="sidebar">
        <div class="panel">
            <div class="section-title">Target Score</div>
            <div class="goal-wrapper">
                <span style="font-size:0.95em; flex:1;">Set target for <span id="goalLabel" style="font-weight:600;">Main</span>:</span>
                <input type="number" id="targetScore" placeholder="250" onchange="saveGoal()">
            </div>
        </div>

        <div class="panel">
            <h3 style="margin-top:0; margin-bottom: 20px; font-size: 1.1rem;">Add Result</h3>
            <form id="entryForm">
                <div class="row-inputs">
                    <div class="input-group">
                        <label>Date</label>
                        <input type="date" id="iDate" required>
                    </div>
                    <div class="input-group">
                        <label>Max Marks</label>
                        <input type="number" id="iMaxMarks" placeholder="300" required>
                    </div>
                </div>
                <div class="input-group">
                    <label>Test Name</label>
                    <input type="text" id="iName" placeholder="e.g. Minor Test 5" required>
                </div>
                
                <hr style="border:0; border-top:1px solid var(--border); margin: 24px 0;">
                
                <div class="input-group">
                    <div class="section-title">
                        <span>Physics</span> <span style="color:var(--text-secondary); font-size: 0.75rem;">Marks | Rank</span>
                    </div>
                    <div class="row-inputs">
                        <input type="number" id="iPhyM" placeholder="Marks" required>
                        <input type="number" id="iPhyR" placeholder="Rank">
                    </div>
                    <div class="mini-inputs">
                        <input type="number" id="iPhyQ" placeholder="Attempted" required>
                        <input type="number" id="iPhySilly" placeholder="Silly (-)">
                        <input type="number" id="iPhyConc" placeholder="Concept (-)">
                    </div>
                </div>

                <div class="input-group">
                    <div class="section-title">
                        <span>Chemistry</span> <span style="color:var(--text-secondary); font-size: 0.75rem;">Marks | Rank</span>
                    </div>
                    <div class="row-inputs">
                        <input type="number" id="iChemM" placeholder="Marks" required>
                        <input type="number" id="iChemR" placeholder="Rank">
                    </div>
                    <div class="mini-inputs">
                        <input type="number" id="iChemQ" placeholder="Attempted" required>
                        <input type="number" id="iChemSilly" placeholder="Silly (-)">
                        <input type="number" id="iChemConc" placeholder="Concept (-)">
                    </div>
                </div>

                <div class="input-group">
                    <div class="section-title">
                        <span>Math</span> <span style="color:var(--text-secondary); font-size: 0.75rem;">Marks | Rank</span>
                    </div>
                    <div class="row-inputs">
                        <input type="number" id="iMathM" placeholder="Marks" required>
                        <input type="number" id="iMathR" placeholder="Rank">
                    </div>
                    <div class="mini-inputs">
                        <input type="number" id="iMathQ" placeholder="Attempted" required>
                        <input type="number" id="iMathSilly" placeholder="Silly (-)">
                        <input type="number" id="iMathConc" placeholder="Concept (-)">
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 24px;">
                    <label>Summary</label>
                    <div class="row-inputs">
                        <input type="number" id="iTotalM" placeholder="Total" readonly style="opacity:0.7; font-weight:bold; background: var(--bg);">
                        <input type="number" id="iTotalR" placeholder="AIR / Rank" required>
                    </div>
                </div>
                <button type="submit" class="btn-primary">Save Entry</button>
            </form>
        </div>
    </div>

    <div class="content">
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-val" id="sAvg">-</div>
                <div class="stat-label">Average Score</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="sAcc">-</div>
                <div class="stat-label">Avg. Accuracy</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" style="color:var(--accent-silly)" id="sSilly">-</div>
                <div class="stat-label">Avg. Silly Loss</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="sTarget">-</div>
                <div class="stat-label">Gap to Target</div>
            </div>
        </div>

        <div class="section-header">Score & Accuracy</div>
        <div class="charts-container">
            <div class="chart-card full-width">
                <canvas id="cTrend"></canvas>
            </div>
            <div class="chart-card full-width">
                <canvas id="cAccuracy"></canvas>
            </div>
            <div class="chart-card">
                <canvas id="cSubjects"></canvas>
            </div>
            <div class="chart-card">
                <canvas id="cMistakes"></canvas>
            </div>
        </div>

        <div class="section-header">Rank Analysis</div>
        <div class="charts-container">
             <div class="chart-card full-width">
                <canvas id="cRankTrend"></canvas>
            </div>
            <div class="chart-card full-width">
                <canvas id="cSubjectRanks"></canvas>
            </div>
        </div>

        <div class="panel">
            <h3 style="margin-top:0">History Log</h3>
            <div style="overflow-x:auto; -webkit-overflow-scrolling: touch;">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Test</th>
                            <th>Phy</th>
                            <th>Chem</th>
                            <th>Math</th>
                            <th>Total</th>
                            <th>Acc</th>
                            <th>Rank</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- State ---
    let mode = 'Main';
    let dataStore = JSON.parse(localStorage.getItem('jeeTracker_v8')) || { entries: [], goals: { Main: 250, Adv: 180 } };
    let charts = {};

    // --- Init ---
    if (localStorage.getItem('theme') === 'dark') setDarkTheme(true);
    updateDefaultUI();
    ['iPhyM', 'iChemM', 'iMathM'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
            const sum = ['iPhyM', 'iChemM', 'iMathM'].reduce((a, cid) => a + (Number(document.getElementById(cid).value)||0), 0);
            document.getElementById('iTotalM').value = sum;
        });
    });

    // --- Core Functions ---
    function updateDefaultUI() {
        document.getElementById('targetScore').value = dataStore.goals[mode] || '';
        document.getElementById('iMaxMarks').value = mode === 'Main' ? 300 : '';
        document.getElementById('iMaxMarks').placeholder = mode === 'Main' ? '300' : 'e.g. 180, 360';
        document.getElementById('goalLabel').innerText = mode;
    }

    function setMode(newMode) {
        mode = newMode;
        document.getElementById('tabMain').classList.toggle('active', mode === 'Main');
        document.getElementById('tabAdv').classList.toggle('active', mode === 'Adv');
        updateDefaultUI();
        render();
    }

    function saveGoal() {
        dataStore.goals[mode] = Number(document.getElementById('targetScore').value);
        saveData();
        render();
    }

    function saveData() { localStorage.setItem('jeeTracker_v8', JSON.stringify(dataStore)); }
    function setDarkTheme(isDark) { 
        document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light'); 
        localStorage.setItem('theme', isDark ? 'dark' : 'light'); 
        document.getElementById('themeIcon').innerText = isDark ? 'Light Mode' : 'Dark Mode';
        render(); 
    }
    function toggleTheme() { setDarkTheme(document.documentElement.getAttribute('data-theme') !== 'dark'); }

    // --- Form & Data ---
    document.getElementById('entryForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const entry = {
            id: Date.now(),
            type: mode,
            date: document.getElementById('iDate').value,
            name: document.getElementById('iName').value,
            maxMarks: Number(document.getElementById('iMaxMarks').value),
            phy: { 
                score: Number(document.getElementById('iPhyM').value),
                rank: Number(document.getElementById('iPhyR').value) || 0,
                qAtt: Number(document.getElementById('iPhyQ').value) || 0,
                silly: Number(document.getElementById('iPhySilly').value) || 0,
                conc: Number(document.getElementById('iPhyConc').value) || 0
            },
            chem: { 
                score: Number(document.getElementById('iChemM').value),
                rank: Number(document.getElementById('iChemR').value) || 0,
                qAtt: Number(document.getElementById('iChemQ').value) || 0,
                silly: Number(document.getElementById('iChemSilly').value) || 0,
                conc: Number(document.getElementById('iChemConc').value) || 0
            },
            math: { 
                score: Number(document.getElementById('iMathM').value),
                rank: Number(document.getElementById('iMathR').value) || 0,
                qAtt: Number(document.getElementById('iMathQ').value) || 0,
                silly: Number(document.getElementById('iMathSilly').value) || 0,
                conc: Number(document.getElementById('iMathConc').value) || 0
            },
            rank: Number(document.getElementById('iTotalR').value)
        };
        entry.total = entry.phy.score + entry.chem.score + entry.math.score;
        dataStore.entries.push(entry);
        dataStore.entries.sort((a,b) => new Date(a.date) - new Date(b.date));
        saveData();
        e.target.reset();
        updateDefaultUI();
        render();
    });

    function deleteEntry(id) {
        if(confirm('Are you sure you want to delete this entry?')) {
            dataStore.entries = dataStore.entries.filter(e => e.id !== id);
            saveData();
            render();
        }
    }

    function exportData() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(dataStore,null,2)], { type: "application/json" }));
        a.download = `test_analysis_backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
    }

    function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imp = JSON.parse(e.target.result);
                if(imp.entries) { dataStore = imp; saveData(); render(); alert('Import successful!'); }
            } catch(e) { alert('Invalid File'); }
        };
        reader.readAsText(file);
    }

    // --- Helper for Accuracy ---
    function calcAcc(score, qAtt) {
        if (!qAtt || qAtt === 0) return 0;
        const marksAtt = qAtt * 4;
        let acc = (score / marksAtt) * 100;
        return acc < 0 ? 0 : acc > 100 ? 100 : acc;
    }

    // --- Rendering ---
    function render() {
        const data = dataStore.entries.filter(e => e.type === mode);
        updateStats(data);
        updateTable(data);
        updateCharts(data);
    }

    function updateStats(data) {
        if (!data.length) { ['sAvg','sAcc','sSilly','sTarget'].forEach(id => document.getElementById(id).innerText = '-'); return; }
        
        const avgScore = (data.reduce((a,c) => a + c.total, 0) / data.length).toFixed(0);
        
        // Avg Accuracy (Weighted by attempts)
        let totalScore = 0, totalAttMarks = 0;
        data.forEach(e => {
            totalScore += e.total;
            totalAttMarks += ((e.phy.qAtt||0) + (e.chem.qAtt||0) + (e.math.qAtt||0)) * 4;
        });
        const avgAcc = totalAttMarks === 0 ? 0 : ((totalScore / totalAttMarks) * 100).toFixed(1);

        const avgSilly = (data.reduce((a,c) => a + c.phy.silly + c.chem.silly + c.math.silly, 0) / data.length).toFixed(1);
        const diff = data[data.length - 1].total - dataStore.goals[mode];
        
        document.getElementById('sAvg').innerText = avgScore;
        document.getElementById('sAcc').innerText = avgAcc + '%';
        document.getElementById('sSilly').innerText = avgSilly;
        document.getElementById('sTarget').innerText = diff >= 0 ? `+${diff}` : diff;
    }

    function updateTable(data) {
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = '';
        [...data].reverse().forEach(e => {
            const totAtt = ((e.phy.qAtt||0) + (e.chem.qAtt||0) + (e.math.qAtt||0));
            const acc = totAtt === 0 ? 0 : ((e.total / (totAtt*4))*100).toFixed(1);
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${e.date}</td>
                <td><span class="badge ${e.type==='Main'?'badge-main':'badge-adv'}">${e.type}</span> ${e.name}</td>
                <td>${e.phy.score}</td>
                <td>${e.chem.score}</td>
                <td>${e.math.score}</td>
                <td style="font-weight:bold">${e.total}</td>
                <td>${acc}%</td>
                <td>#${e.rank}</td>
                <td onclick="deleteEntry(${e.id})" class="delete-btn">Ã—</td>`;
            tbody.appendChild(tr);
        });
    }

    function updateCharts(data) {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const txt = isDark ? '#94a3b8' : '#6b7280';
        const grid = isDark ? '#334155' : '#e5e7eb';
        const dates = data.map(e => e.date);
        
        // Font size bump for charts
        const commonFont = { size: 13, family: "'Inter', sans-serif" };
        
        const opts = { 
            responsive:true, 
            maintainAspectRatio:false, 
            plugins:{
                legend:{labels:{color:txt, font: commonFont}},
                tooltip: { titleFont: {size:14}, bodyFont: {size:14}, padding: 10 }
            }, 
            scales:{
                x:{grid:{color:grid},ticks:{color:txt, font: commonFont}}, 
                y:{grid:{color:grid},ticks:{color:txt, font: commonFont}}
            } 
        };

        // 1. Total Score Trend
        createChart('cTrend', 'line', { labels: dates, datasets: [{ label: 'Total Score', data: data.map(e => e.total), borderColor: '#3b82f6', tension:0.3, fill:true, backgroundColor:'rgba(59,130,246,0.1)' }] }, 
        { ...opts, plugins: { ...opts.plugins, annotation: { annotations: { line1: { type:'line', yMin:dataStore.goals[mode], yMax:dataStore.goals[mode], borderColor:isDark?'#34d399':'#10b981', borderWidth:2, borderDash:[6,6] } } }, title:{display:true, text:'Score Trajectory', color:txt, font: {size:15, weight:'bold'}} } });

        // 2. ACCURACY CHART
        createChart('cAccuracy', 'line', { labels: dates, datasets: [
            { label:'Phy Acc %', data:data.map(e=>calcAcc(e.phy.score, e.phy.qAtt)), borderColor:isDark?'#f87171':'#ef4444', tension:0.2 },
            { label:'Chem Acc %', data:data.map(e=>calcAcc(e.chem.score, e.chem.qAtt)), borderColor:isDark?'#34d399':'#10b981', tension:0.2 },
            { label:'Math Acc %', data:data.map(e=>calcAcc(e.math.score, e.math.qAtt)), borderColor:isDark?'#fbbf24':'#f59e0b', tension:0.2 }
        ] }, { ...opts, scales:{ ...opts.scales, y:{ ...opts.scales.y, min:0, max:100 } }, plugins:{ title:{display:true, text:'Accuracy % (Target: >85%)', color:txt, font: {size:15, weight:'bold'}} } });

        // 3. Subject Score Trend
        createChart('cSubjects', 'line', { labels: dates, datasets: [
            { label:'Phy', data:data.map(e=>e.phy.score), borderColor:isDark?'#f87171':'#ef4444', tension:0.2, borderDash:[2,2] },
            { label:'Chem', data:data.map(e=>e.chem.score), borderColor:isDark?'#34d399':'#10b981', tension:0.2, borderDash:[2,2] },
            { label:'Math', data:data.map(e=>e.math.score), borderColor:isDark?'#fbbf24':'#f59e0b', tension:0.2, borderDash:[2,2] }
        ] }, { ...opts, plugins:{ title:{display:true, text:'Subject Score Trajectory', color:txt, font: {size:15, weight:'bold'}} } });

        // 4. Mistakes
        createChart('cMistakes', 'bar', { labels: dates.slice(-5), datasets: [
            { label:'Silly', data:data.slice(-5).map(e=>e.phy.silly+e.chem.silly+e.math.silly), backgroundColor:'#f43f5e' },
            { label:'Concept', data:data.slice(-5).map(e=>e.phy.conc+e.chem.conc+e.math.conc), backgroundColor:'#8b5cf6' }
        ] }, { ...opts, scales:{x:{stacked:true}, y:{stacked:true}}, plugins:{ title:{display:true, text:'Mistake Analysis (Last 5)', color:txt, font: {size:15, weight:'bold'}} } });

        // 5. Ranks
        createChart('cRankTrend', 'line', { labels: dates, datasets: [{ label: 'AIR', data: data.map(e => e.rank), borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true, tension:0.3 }] },
        { ...opts, scales:{ ...opts.scales, y:{ ...opts.scales.y, reverse: true } }, plugins:{ title:{display:true, text:'Overall Rank', color:txt, font: {size:15, weight:'bold'}} } });

        // 6. Subject Ranks
        createChart('cSubjectRanks', 'line', { labels: dates, datasets: [
            { label:'Phy Rank', data:data.map(e=>e.phy.rank), borderColor:isDark?'#f87171':'#ef4444', borderDash:[5,5], tension:0.2 },
            { label:'Chem Rank', data:data.map(e=>e.chem.rank), borderColor:isDark?'#34d399':'#10b981', borderDash:[5,5], tension:0.2 },
            { label:'Math Rank', data:data.map(e=>e.math.rank), borderColor:isDark?'#fbbf24':'#f59e0b', borderDash:[5,5], tension:0.2 }
        ] }, { ...opts, scales:{ ...opts.scales, y:{ ...opts.scales.y, reverse: true } }, plugins:{ title:{display:true, text:'Subject Ranks', color:txt, font: {size:15, weight:'bold'}} } });
    }

    function createChart(id, type, data, options) {
        const ctx = document.getElementById(id).getContext('2d');
        if (charts[id]) charts[id].destroy();
        charts[id] = new Chart(ctx, { type, data, options });
    }

    render();
</script>

</body>
</html>
